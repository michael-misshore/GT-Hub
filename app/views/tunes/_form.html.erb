<%= form_for(@tune) do |f| %>
  <% if @tune.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@tune.errors.count, "error") %> prohibited this tune from being saved:</h2>

      <ul>
      <% @tune.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

	<!-- Hidden Fields -->
	<%= f.text_field :tuner_id, :value => current_tuner.id, :hidden => true %>
	<!-- END Hidden Fields -->
	
	<div id="tunetabs">
		<ul>
			<li><a href="#basic_info">Basic</a></li>
			<% @groups.each do | group, subgroups | %>
				<li><a href="#<%= group.downcase.gsub(/(\s|\/)/, "_") %>"><%= group %></a></li>
			<% end %>
		</ul>
		
		
		<div id="basic_info">
			<div class="field">
				<b><%= f.label :tune_type %></b><br />
				<%= f.select(:tune_type, options_for_select(['Grip', 'Drift', 'Drag'], @tune.tune_type)) %>
			</div>
			<div class="field">
				<b><%= f.label :car_id %></b><br />
				<%= f.collection_select(:car_id, Car.ordered.all, :id, :display_name) %>
			</div>
			<div class="field">
				<b><%= f.label :track_id %></b><br />
				<%= f.collection_select(:track_id, Track.ordered.all, :id, :name) %>
			</div>
		</div>
		
		<%= render :partial => 'parts', :locals => { :groups => @groups, :tune => @tune, :f => f } %>
		
		<%= f.submit %>
	</div>
<% end %>

<script>

function toggle_settings_for_input (input_id) {
	if ($(input_id).attr('rel')) {
		rel = $(input_id).attr('rel');
		num_checked = 0;
		$('#tunetabs input[rel="' + rel + '"]').each(function() {
			if ($(this).attr('checked')) num_checked++;
		});
		
		if (num_checked) $(rel).show();
		else $(rel).hide();
	}
}

function toggle_settings_for_select (select_id) {
	select_value = $(select_id).val();
	select_has_rel_option = ($(select_id).find('option[rel]').length > 0);
	selected_option = $(select_id).find('option[value='+select_value+']').first();
	
	if (selected_option.attr('rel')) {
		$(selected_option.attr('rel')).show();
	}
	else if (select_has_rel_option) {
		$(select_id).find('option[rel]').each(function() {
			$($(this).attr('rel')).hide();
		});
	}
}

$(document).ready(function() {
	$("#tunetabs").tabs();
	
	$("#tunetabs input").change(function() {
		toggle_settings_for_input('#'+$(this).attr('id'));
	});
	
	$("#tunetabs select").change(function() {
		toggle_settings_for_select('#'+$(this).attr('id'));
	});
	
	$("#tunetabs input").each(function() {
		toggle_settings_for_input('#'+$(this).attr('id'));
	});
	
	$("#tunetabs select").each(function() {
		toggle_settings_for_select('#'+$(this).attr('id'));
	});
});
</script>